# SSD算法以及Faster-RCNN实现通过X光图片检测充电宝

## 一.问题描述

		需要训练目标检测模型，使用这个目标检测模型检测出测试集中每张图片中的危险品（例如输入模型一张测试图片，最终输出这张图片中所有危险品的类别以及位置坐标）。在最后测试结果时，会使用测试集来进行测试，测试集和训练集的文件结构是相同的，但测试集没有给出，所以请从训练集中划分一个验证集出来。在验证集上验证自己模型的效果。



## 二.任务一（遮挡问题）

		数据集中的安检图片都存在不同等级的遮挡问题，遮挡会严重影响检测器识别危险品的准确率。如何解决严重遮挡条件下模型检测危险品问题是一个热点。
	
		安检机返回的x光图像为RGB彩色图像。训练集中的危险品包括带电芯充电宝和不带电芯充电宝两个类别。训练集中共有6000张图片（带电芯充电宝和不带电芯充电宝各3000张，且测试集根据遮挡等级分为了1,2,3种不同的遮挡等级，不同遮挡等级的示意图见图1）。每张图片都拥有一个危险品所在的位置标注文件，标注文件里的每行表示（危险品的名称，危险品位置的左上坐标，危险品位置的右下坐标）。
	
		最后将修改测试文件中的数据集路径，将其改为测试集所在的路径。之后分别得出3个遮挡等级各自的map。根据3个map与对应遮挡等级的权重（等级1权重0.2，等级2权重0.3，等级3权重0.5）相乘后得到的分数相加得出最终的分数。

## 三.作业流程
		分别使用了SSD与Faster-RCNN两种算法进行目标检测，试图分析比较两种算法的异同以及在本数据集上的表现。在进行训练前，将数据集按照VOC2007的模式进行改变，之后进行训练，对比结果，改变参数优化模型。

## 四.SSD模型介绍

		本项目主要采用的一种解决目标检测问题的方法为SSD模型，来源于Wei Liu的论文《SSD: Single Shot MultiBox Detector》，主要的思想和特点在于:
- 目标检测的定义理解为物体多个边界框如何进行有效回归的问题，在处理过程中会对网络框进行置信度得分设置，较高的置信度意味着该显示框匹配对象的可能性越高。
+ 在模型优化和回归过程中，通过反向传播优化预测框和Ground Truth的相似度，从位置和分类两个角度进行分析和考虑。

+ 增加边界框的可拓展型，设置多重比例的预选框，但在物体类别确定时，Bounding Box的数量不会随之上升，易拓展于较大的数据集中。

  #### 1.网络结构介绍

  ![img](https://img-blog.csdnimg.cn/20190307162727290.png)

		本项目在将VGG16作为Base NetWork的基础上，使用6个不同特征图检测不同尺度的目标，低层预测小目标，高层预测大目标。
  #### 2.多种宽高比预测框
  
  ![img](https://img-blog.csdn.net/201808251642571?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW5xaW5nMTM1Nzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
  
			SSD模型采用特征金字塔，从不同尺度的特征图下面来预测目标分类与位置。
			在金字塔结构中每一部分都有3*3的卷积来进行预测，在某个位置上得到一个预测值，这个预测值可能是一个分类的得分，也可能是现对于默认框的的位置偏差。从SSD网络结构图中可以看出来conv6-2，conv7-2，conv8-2，conv9-2，fc7，conv4-2。
			尺度线框的设定方式为：

$$
S_k=S_{min}+\frac{S_{max}-S{min}}{m-1}(K-1)
$$
$$
a_r\in{1,2,3,\frac{1}{2},\frac{1}{3}}
$$
$$
\omega_k^a=\sqrt{a_r}  h_k^a=\frac{s_k}{\sqrt{a_r}}
$$

  #### 3.损失函数
		损失函数定义为位置误差（locatization loss,loc）与置信度误差（confidence loss,conf）的加权和：
$$
L(x,c,l,g)=\frac{1}{N}(L_{conf}(x,c)+\alpha L_{loc}(x,l,g))
$$

		对于位置误差，其采用Smooth L1 loss,对于置信度误差，其采用softmax loss。

## 五.预测过程
		预测过程中对于每个预测框，首先根据类别置信度确定其类别（置信度最大者）与置信度值，并过滤掉属于背景的预测框。
		然后根据置信度阈值（如0.5）过滤掉阈值较低的预测框。对于留下的预测框进行解码，根据先验框得到其真实的位置参数（解码后一般还需要做clip，防止预测框位置超出图片）。解码之后，一般需要根据置信度进行降序排列，
		然后仅保留top-k（如400）个预测框。最后就是进行NMS算法，过滤掉那些重叠度较大的预测框。最后剩余的预测框就是检测结果了。

## 六.Faster-RCNN模型简介
		与SSD算法属于One Stage目标检测算法不同的是，Fast-RCNN属于Two Stage算法。Two Stage目标检测算法先进行区域生成（region proposal，RP）（一个有可能包含待检物体的预选框），再通过卷积神经网络进行样本分类。One Stage算法则不用进行RP,直接在网络中提取特征来预测物体分类和位置。

